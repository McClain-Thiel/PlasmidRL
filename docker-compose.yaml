x-common: &common
  build:
    context: .
    dockerfile: Dockerfile
  working_dir: /mcclain
  env_file:
    - .env
  volumes:
    - ./:/mcclain
  restart: unless-stopped
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

services:
  # Interactive shell for debugging
  dev:
    <<: *common
    command: bash
    tty: true

  # TRL: GRPO training
  grpo-trl:
    <<: *common
    command: >
      bash -lc "
        uv sync --frozen && uv run python -m src.runners.grpo
      "
    environment:
      # Hard-coded W&B project specifics for this repo
      - WANDB_PROJECT=plasmidrl
      - WANDB_ENTITY=mcclain
      # Single simple flag to optionally resume
      - RESUME=${RESUME:-false}

  # TRL: Evolution Strategies optimization
  es:
    <<: *common
    command: >
      bash -lc "
        uv sync --frozen && uv run python -m src.runners.es
      "
    environment:
      - WANDB_PROJECT=plasmidrl
      - WANDB_ENTITY=mcclain

  # VERL: PPO trainer
  verl-ppo:
    build:
      context: .
      dockerfile: docker/verl.Dockerfile
    working_dir: /mcclain
    volumes:
      - ./:/mcclain
      - ./config/verl_ppo.yaml:/opt/verl/verl/trainer/config/verl_ppo.yaml:ro
    environment:
      - WANDB_PROJECT=plasmidrl
      - WANDB_ENTITY=mcclain
      - HF_TOKEN=${HF_TOKEN}
      - WANDB_API_KEY=${WANDB_API_KEY}
    command: >
      bash -lc "
        echo 'Starting VERL PPO...' && python3 -m verl.trainer.main_ppo --config-name verl_ppo
      "
    

  # VERL: GRPO trainer
  verl-grpo:
    build:
      context: .
      dockerfile: docker/verl.Dockerfile
    working_dir: /mcclain
    volumes:
      - ./:/mcclain
      - ./config/verl_grpo.yaml:/opt/verl/verl/trainer/config/verl_grpo.yaml:ro
    environment:
      - WANDB_PROJECT=plasmidrl
      - WANDB_ENTITY=mcclain
      - HF_TOKEN=${HF_TOKEN}
      - WANDB_API_KEY=${WANDB_API_KEY}
    command: >
      bash -lc "
        echo 'Starting VERL GRPO...' && python3 -m verl.trainer.main_ppo --config-name verl_grpo
      "
    

  # Optional: evaluation CLI if present
  eval:
    <<: *common
    command: >
      bash -lc "uv sync --frozen && uv run -m src.cli eval"
