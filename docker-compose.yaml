x-common: &common
  build:
    context: .
    dockerfile: Dockerfile
  working_dir: /mcclain
  env_file:
    - .env
  volumes:
    - ./:/mcclain
  restart: unless-stopped

services:
  # Interactive shell for debugging
  dev:
    <<: *common
    command: bash
    tty: true
    gpus: all

  # Training job (GRPO-based RL)
  train:
    <<: *common
    command: >
      bash -lc "
        uv sync --frozen &&
        uv run python -m src.runners.rl_env
      "
    environment:
      # Hard-coded W&B project specifics for this repo
      - WANDB_PROJECT=plasmidrl
      - WANDB_ENTITY=mcclain
      # Single simple flag to optionally resume
      - RESUME=${RESUME:-false}
    depends_on:
      server:
        condition: service_healthy
    gpus: all

  # FastAPI backend required by train
  server:
    build:
      context: ${PLASMID_SERVER_PATH:-../Plasmid-Informatics-Server}
    restart: unless-stopped
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 60s
      retries: 5
      start_period: 90s

