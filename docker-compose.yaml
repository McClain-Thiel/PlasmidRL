
# this is the yaml version of a function or variable we can reuse
x-common: &common
  build:
    context: .
    dockerfile: docker/Dockerfile
  working_dir: /mcclain
  env_file:
    - .env
  volumes:
    - ./:/mcclain
  restart: unless-stopped
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

x-s3: &s3mount
  - /mnt/s3/phd-research-storage-1758274488:/s3:rw

services:
  # Interactive shell for debugging
  dev:
    <<: *common
    command: bash
    tty: true

  # TRL: GRPO training
  grpo-trl:
    <<: *common
    volumes:
      - ./:/mcclain
      - /mnt/s3/phd-research-storage-1758274488:/s3:rw
    command: >
      bash -lc "
        mkdir -p /tmp/wandb && \
        uv sync --frozen && uv run python -m src.runners.grpo
      "
    environment:
      # W&B settings for this job
      - WANDB_ENTITY=ucl-cssb
      - WANDB_PROJECT=PlasmidRL
      - WANDB_TAGS=["plasmid","rl","trl","grpo"]
      - WANDB_NOTES=TRL GRPO training on plasmid design
      - WANDB_DIR=/tmp/wandb
      # Single simple flag to optionally resume
      - RESUME=${RESUME:-false}

  # TRL: Evolution Strategies optimization
  es:
    <<: *common
    command: >
      bash -lc "
        uv sync --frozen && uv run python -m src.runners.es
      "
    environment:
      - WANDB_ENTITY=mcclain
      - WANDB_PROJECT=plasmidrl-trl-es
      - WANDB_TAGS=["plasmid","rl","trl","es"]
      - WANDB_NOTES=TRL Evolution Strategies optimization

  # W&B Sweep Agent for hyperparameter optimization
  grpo-sweep:
    <<: *common
    volumes:
      - ./:/mcclain
      - /mnt/s3/phd-research-storage-1758274488:/s3:rw
    command: >
      bash -lc "
        mkdir -p /tmp/wandb && \
        export PYTHONPATH=/mcclain && \
        uv sync --frozen && \
        uv run wandb agent ${SWEEP_ID}
      "
    environment:
      - WANDB_ENTITY=ucl-cssb
      - WANDB_PROJECT=PlasmidRL
      - WANDB_DIR=/tmp/wandb
      - SWEEP_ID=${SWEEP_ID}
      - PYTHONPATH=/mcclain

  # VERL: PPO trainer
  verl-ppo:
    build:
      context: .
      dockerfile: docker/verl.Dockerfile
    working_dir: /mcclain
    volumes:
      - ./:/mcclain
      - ./config/verl_ppo.yaml:/opt/verl/verl/trainer/config/verl_ppo.yaml:ro
      - /mnt/s3/phd-research-storage-1758274488:/s3:rw
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - WANDB_ENTITY=mcclain
      - WANDB_PROJECT=plasmidrl-verl-ppo
      - WANDB_TAGS=["plasmid","rl","verl","ppo"]
      - WANDB_NOTES=VERL PPO trainer
      - HF_TOKEN=${HF_TOKEN}
      - WANDB_API_KEY=${WANDB_API_KEY}
    command: >
      bash -lc "
        echo 'Starting VERL PPO...' && python3 -m verl.trainer.main_ppo --config-name verl_ppo
      "
    

  # VERL: GRPO trainer
  verl-grpo:
    build:
      context: .
      dockerfile: docker/verl.Dockerfile
    working_dir: /mcclain
    shm_size: 8g
    volumes:
      - ./:/mcclain
      - ./config/verl_grpo.yaml:/opt/verl/verl/trainer/config/verl_grpo.yaml:ro
      - /mnt/s3/phd-research-storage-1758274488:/s3:rw
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - WANDB_ENTITY=ucl-cssb
      - WANDB_PROJECT=plasmid-rl
      - WANDB_TAGS=["plasmid","rl","grpo"]
      - WANDB_NOTES=VERL GRPO trainer
      - HF_TOKEN=${HF_TOKEN}
      - WANDB_API_KEY=${WANDB_API_KEY}
    command: >
      bash -lc "
        echo 'Starting VERL GRPO...' && python3 -m verl.trainer.main_ppo --config-name verl_grpo
      "
    
  infer:
    <<: *common
    volumes:
      - ./:/mcclain
      - /mnt/s3/phd-research-storage-1758274488:/s3:rw
    command: >
      bash -lc "
        uv sync --frozen && uv run python -m src.runners.generate_samples
      "

  # Optional: evaluation CLI if present
  eval:
    <<: *common
    command: >
      bash -lc "uv sync --frozen && uv run -m src.cli eval"
    environment:
      - WANDB_ENTITY=mcclain
      - WANDB_PROJECT=plasmidrl-eval
      - WANDB_TAGS=["eval"]
      - WANDB_NOTES=Evaluation job
